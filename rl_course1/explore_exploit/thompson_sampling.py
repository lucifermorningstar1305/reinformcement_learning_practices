from typing import List

import numpy as np
import matplotlib.pyplot as plt
import os

from scipy.stats import beta
from bandit import BanditThompson


BANDIT_PROBS = [0.2, 0.5, 0.75]
NUM_TRIALS = 100_000


def plot(bandits: List, trial: int):
    fig = plt.figure()
    x = np.linspace(0, 1, 200)
    for b in bandits:
        y = beta.pdf(x, b.a, b.b)
        plt.plot(x, y, label=f"real p: {b.p:.4f}, win rate={b.a - 1}/{b.n_samples}")

    plt.title(f"Bandit distribution after {trial} trials")
    plt.legend()
    fig.savefig(f"./media/thompson_trial={trial}.png")


def experiment():
    bandits = [BanditThompson(p) for p in BANDIT_PROBS]

    log_pts = [5, 10, 20, 50, 100, 200, 500, 1000, 1500, 1999]
    rewards = np.zeros(NUM_TRIALS)

    for i in range(NUM_TRIALS):
        j = np.argmax([b.sample() for b in bandits])
        x = bandits[j].pull()
        bandits[j].update(x)

        rewards[i] = x
        if i in log_pts:
            plot(bandits=bandits, trial=i)

    print(f"Total rewards earned: {rewards.sum()}")
    print(f"overall win rate: {rewards.sum() / NUM_TRIALS}")
    print(f"num of times each bandits were selected: {[b.n_samples for b in bandits]}")


if __name__ == "__main__":
    if not os.path.exists("./media"):
        os.mkdir("./media")

    experiment()
